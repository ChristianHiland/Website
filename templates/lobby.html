<html lang="en">
<head>
    <style>
        /* Text */
        .BarTitle {color: white; text-align: center;}
        .barmenu {background-color: gray;}
        .BodyTitle {color: white;}
        .BodyText {color: white; font-size: 18px; margin-left: 10px; margin-right: 10px;}
        
        /* Divs */
        .BodyDiv {background-color: gray; align-items: center; text-align: center; display: flex; margin-top: 15px; justify-content: center;}
        .BodyDiv1 {background-color: #1b385d; width: 20%; margin-top: 1%; margin-bottom: 1%; width: fit-content;}
        .BodyDiv2 {background-color: #1b385d; width: 20%; margin-left: .5%; margin-top: 1%; margin-bottom: 1%; width: 60%; justify-content: center; align-items: center;}

        /* Bar Nav */
        .BarNavul {position: -webkit-sticky; position: sticky; list-style-type: none; margin: 0; padding: 0; overflow: hidden; background-color: #333;}
        .BarNavli {float: left;}
        .BarNavli a {display: block; color: white; text-align: center; padding: 14px 16px; text-decoration: none;}
        .BarNavli a:hover {background-color: #111;}
        /* Active/Current Page */
        .active {background-color: darkblue;}
        /* Extras */
        .centered {text-align: center; align-content: center; align-self: center; padding-top: 10px;}
        .white-text {color: white; padding-left: 20px; padding-right: 20px;}
        .messagecontainer {align-self: center; align-items: center; text-align: center;}
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <title>Login -- lunproject.net</title>
</head>
<body>
    <!-- Bar Menu -->
    <div class="barmenu">
        <ul class="BarNavul">
            <h1 class="BarTitle">lunprojects.net</h1>
            <hr class="DivHR">
            <li class="BarNavli"><a href="{{url_for('index')}}">Home</a></li>
            <li class="BarNavli"><a href="{{url_for('projects')}}">Projects</a></li>
            <li class="BarNavli" style="float:right"><a href="{{url_for('howlinghaven')}}">Howling Haven</a></li>
            <li class="BarNavli"><a href="{{url_for('links')}}">Links</a></li>
            <li class="BarNavli"><a id="LoginID" href="{{url_for('login')}}">Login</a></li>
            <li class="BarNavli"><a href="{{url_for('profiles')}}">Profiles</a></li>
            <li class="BarNavli"><a href="{{url_for('lobby')}}" class="active">Lobby</a></li>
            <li class="BarNavli"><a href="{{url_for('about')}}">About</a></li>
        </ul>    
    </div>

    <!-- Main Div -->
    <div class="BodyDiv">
        <div class="BodyDiv2">
            <h2 class="white-text">Welcome to the Lobby!</h2>
            <input type="text" id="message" name="message" placeholder="Hello!" style="padding-top: 10px; width: 90%" required>
            
            <!-- Submit Button -->
            <div class="mt-6" style="padding-top: 8px;">
                <button type="submit" onclick="Lobby_send()" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Send</button>
                <button type="submit" id="loadMessagesBtn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Update</button>
            </div>
        </div>
    </div>
    <!-- The container where messages will be dynamically added -->
    <div id="message-container" class="h-80 bg-gray-50 border border-gray-200 rounded-lg p-4 space-y-4 overflow-y-auto">
        <!-- Messages will be injected here by JavaScript -->
        <p class="text-gray-400 text-center">Messages will appear here...</p>
    </div>

    <script src="/src/scripts/lobby.js" async></script>

    <script>
        // Get references to the HTML elements
        const message_textfield = document.getElementById("message");
        const dataOutputTextArea = document.getElementById("message-area");
        const loadMessagesBtn = document.getElementById('loadMessagesBtn');
        const messageContainer = document.getElementById('message-container');

        // Add a click event listener to the button
        loadMessagesBtn.addEventListener('click', loadAndDisplayMessagesFromServer);

        function loadAndDisplayMessagesFromServer() {
            // The URL of your Flask server's endpoint
            const apiUrl = "{{url_for('lobby_chatlog')}}";

            // Clear existing content and show a loading message
            messageContainer.innerHTML = '<p class="text-gray-400 text-center">Loading...</p>';

            // Use the fetch API to get data from the server
            fetch(apiUrl)
                .then(response => {
                    // Check if the request was successful
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    // Parse the JSON data from the response
                    return response.json();
                })
                .then(data => {
                    // Clear the "Loading..." message
                    messageContainer.innerHTML = '';

                    // Check if the messages array exists and is an array
                    if (data && Array.isArray(data.messages)) {
                        // Loop through each message object in the array
                        data.messages.forEach(message => {
                            // Create the HTML elements for the message
                            const messageElement = document.createElement('div');
                            messageElement.className = 'p-4 rounded-lg shadow-sm bg-white border border-gray-200 animate-fade-in';

                            const headerElement = document.createElement('div');
                            headerElement.className = 'flex justify-between items-center mb-1';

                            const senderElement = document.createElement('span');
                            senderElement.className = 'font-bold';
                            // Dynamically set the color from the data
                            if(message.color) {
                                senderElement.style.color = message.color;
                            }
                            senderElement.textContent = message.sender;

                            const timeElement = document.createElement('span');
                            timeElement.className = 'text-xs text-gray-500';
                            // Use the 'datetime' field from your JSON, providing a fallback
                            timeElement.textContent = message.datetime || 'no timestamp';

                            const contentElement = document.createElement('p');
                            contentElement.className = 'text-gray-800';
                            contentElement.textContent = message.content;

                            // Assemble the elements
                            headerElement.appendChild(senderElement);
                            headerElement.appendChild(timeElement);
                            messageElement.appendChild(headerElement);
                            messageElement.appendChild(contentElement);

                            // Add the fully assembled message to the container
                            messageContainer.appendChild(messageElement);
                        });
                    } else {
                         messageContainer.innerHTML = '<p class="text-red-500 text-center">Error: Invalid data format received from server.</p>';
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    // Display an error message in the container
                    messageContainer.innerHTML = `<p class="text-red-500 text-center">Could not connect to the server. Make sure it's running. <br><br> ${error.message}</p>`;
                });
        }

        function Lobby_send() {
            const Data = {
                sender: localStorage.getItem("username"),
                content: message_textfield.value
            }

            fetch('/lobby_send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(Data)
            })
            .then(response => {
                if (!response.ok) {throw new Error('Network response was not ok');}
            })
        }
    </script>
    
    <!-- Simple fade-in animation using CSS -->
    <style>
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>

</body>
</html>